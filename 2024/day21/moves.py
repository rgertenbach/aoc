from functools import cache


A = "A"
U = "^"
D = "v"
L = "<"
R = ">"


NUMPAD_PRESSES = {
    "A": {
        "A": {U: 0, D: 0, L: 0, R: 0},
        "0": {U: 0, D: 0, L: 1, R: 0},
        "1": {U: 1, D: 0, L: 2, R: 0},
        "2": {U: 1, D: 0, L: 1, R: 0},
        "3": {U: 1, D: 0, L: 0, R: 0},
        "4": {U: 2, D: 0, L: 2, R: 0},
        "5": {U: 2, D: 0, L: 1, R: 0},
        "6": {U: 2, D: 0, L: 0, R: 0},
        "7": {U: 3, D: 0, L: 2, R: 0},
        "8": {U: 3, D: 0, L: 1, R: 0},
        "9": {U: 3, D: 0, L: 0, R: 0},
    },
    "0": {
        "A": {U: 0, D: 0, L: 0, R: 1},
        "0": {U: 0, D: 0, L: 0, R: 0},
        "1": {U: 1, D: 0, L: 1, R: 0},
        "2": {U: 1, D: 0, L: 0, R: 0},
        "3": {U: 1, D: 0, L: 0, R: 1},
        "4": {U: 2, D: 0, L: 1, R: 0},
        "5": {U: 2, D: 0, L: 0, R: 0},
        "6": {U: 2, D: 0, L: 0, R: 1},
        "7": {U: 3, D: 0, L: 1, R: 0},
        "8": {U: 3, D: 0, L: 0, R: 0},
        "9": {U: 3, D: 0, L: 0, R: 1},
    },
    "1": {
        "A": {U: 0, D: 1, L: 0, R: 2},
        "0": {U: 0, D: 1, L: 0, R: 1},
        "1": {U: 0, D: 0, L: 0, R: 0},
        "2": {U: 0, D: 0, L: 0, R: 1},
        "3": {U: 0, D: 0, L: 0, R: 2},
        "4": {U: 1, D: 0, L: 0, R: 0},
        "5": {U: 1, D: 0, L: 0, R: 1},
        "6": {U: 1, D: 0, L: 0, R: 2},
        "7": {U: 2, D: 0, L: 0, R: 0},
        "8": {U: 2, D: 0, L: 0, R: 1},
        "9": {U: 2, D: 0, L: 0, R: 2},
    },
    "2": {
        "A": {U: 0, D: 1, L: 0, R: 1},
        "0": {U: 0, D: 1, L: 0, R: 0},
        "1": {U: 0, D: 0, L: 1, R: 0},
        "2": {U: 0, D: 0, L: 0, R: 0},
        "3": {U: 0, D: 0, L: 0, R: 1},
        "4": {U: 1, D: 0, L: 1, R: 0},
        "5": {U: 1, D: 0, L: 0, R: 0},
        "6": {U: 1, D: 0, L: 0, R: 1},
        "7": {U: 2, D: 0, L: 1, R: 0},
        "8": {U: 2, D: 0, L: 0, R: 0},
        "9": {U: 2, D: 0, L: 0, R: 1},
    },
    "3": {
        "A": {U: 0, D: 1, L: 0, R: 0},
        "0": {U: 0, D: 1, L: 1, R: 0},
        "1": {U: 0, D: 0, L: 2, R: 0},
        "2": {U: 0, D: 0, L: 1, R: 0},
        "3": {U: 0, D: 0, L: 0, R: 0},
        "4": {U: 1, D: 0, L: 2, R: 0},
        "5": {U: 1, D: 0, L: 1, R: 0},
        "6": {U: 1, D: 0, L: 0, R: 0},
        "7": {U: 2, D: 0, L: 2, R: 0},
        "8": {U: 2, D: 0, L: 1, R: 0},
        "9": {U: 2, D: 0, L: 0, R: 0},
    },
    "4": {
        "A": {U: 0, D: 2, L: 0, R: 2},
        "0": {U: 0, D: 2, L: 0, R: 1},
        "1": {U: 0, D: 1, L: 0, R: 0},
        "2": {U: 0, D: 1, L: 0, R: 1},
        "3": {U: 0, D: 1, L: 0, R: 2},
        "4": {U: 0, D: 0, L: 0, R: 0},
        "5": {U: 0, D: 0, L: 0, R: 1},
        "6": {U: 0, D: 0, L: 0, R: 2},
        "7": {U: 1, D: 0, L: 0, R: 0},
        "8": {U: 1, D: 0, L: 0, R: 1},
        "9": {U: 1, D: 0, L: 0, R: 2},
    },
    "5": {
        "A": {U: 0, D: 2, L: 0, R: 1},
        "0": {U: 0, D: 2, L: 0, R: 0},
        "1": {U: 0, D: 1, L: 1, R: 0},
        "2": {U: 0, D: 1, L: 0, R: 0},
        "3": {U: 0, D: 1, L: 0, R: 1},
        "4": {U: 0, D: 0, L: 1, R: 0},
        "5": {U: 0, D: 0, L: 0, R: 0},
        "6": {U: 0, D: 0, L: 0, R: 1},
        "7": {U: 1, D: 0, L: 1, R: 0},
        "8": {U: 1, D: 0, L: 0, R: 0},
        "9": {U: 1, D: 0, L: 0, R: 1},
    },
    "6": {
        "A": {U: 0, D: 2, L: 0, R: 0},
        "0": {U: 0, D: 2, L: 1, R: 0},
        "1": {U: 0, D: 1, L: 2, R: 0},
        "2": {U: 0, D: 1, L: 1, R: 0},
        "3": {U: 0, D: 1, L: 0, R: 0},
        "4": {U: 0, D: 0, L: 2, R: 0},
        "5": {U: 0, D: 0, L: 1, R: 0},
        "6": {U: 0, D: 0, L: 0, R: 0},
        "7": {U: 1, D: 0, L: 2, R: 0},
        "8": {U: 1, D: 0, L: 1, R: 0},
        "9": {U: 1, D: 0, L: 0, R: 0},
    },
    "7": {
        "A": {U: 0, D: 3, L: 0, R: 2},
        "0": {U: 0, D: 3, L: 0, R: 1},
        "1": {U: 0, D: 2, L: 0, R: 0},
        "2": {U: 0, D: 2, L: 0, R: 1},
        "3": {U: 0, D: 2, L: 0, R: 2},
        "4": {U: 0, D: 1, L: 0, R: 0},
        "5": {U: 0, D: 1, L: 0, R: 1},
        "6": {U: 0, D: 1, L: 0, R: 2},
        "7": {U: 0, D: 0, L: 0, R: 0},
        "8": {U: 0, D: 0, L: 0, R: 1},
        "9": {U: 0, D: 0, L: 0, R: 2},
    },
    "8": {
        "A": {U: 0, D: 3, L: 0, R: 1},
        "0": {U: 0, D: 3, L: 0, R: 0},
        "1": {U: 0, D: 2, L: 1, R: 0},
        "2": {U: 0, D: 2, L: 0, R: 0},
        "3": {U: 0, D: 2, L: 0, R: 1},
        "4": {U: 0, D: 1, L: 1, R: 0},
        "5": {U: 0, D: 1, L: 0, R: 0},
        "6": {U: 0, D: 1, L: 0, R: 1},
        "7": {U: 0, D: 0, L: 1, R: 0},
        "8": {U: 0, D: 0, L: 0, R: 0},
        "9": {U: 0, D: 0, L: 0, R: 1},
    },
    "9": {
        "A": {U: 0, D: 3, L: 0, R: 0},
        "0": {U: 0, D: 3, L: 1, R: 0},
        "1": {U: 0, D: 2, L: 2, R: 0},
        "2": {U: 0, D: 2, L: 1, R: 0},
        "3": {U: 0, D: 2, L: 0, R: 0},
        "4": {U: 0, D: 1, L: 2, R: 0},
        "5": {U: 0, D: 1, L: 1, R: 0},
        "6": {U: 0, D: 1, L: 0, R: 0},
        "7": {U: 0, D: 0, L: 2, R: 0},
        "8": {U: 0, D: 0, L: 1, R: 0},
        "9": {U: 0, D: 0, L: 0, R: 0},
    },
}

ARROW_PRESSES = {
    "A": {
        "A": {U: 0, D: 0, L: 0, R: 0},
        "^": {U: 0, D: 0, L: 1, R: 0},
        "v": {U: 0, D: 1, L: 1, R: 0},
        "<": {U: 0, D: 1, L: 2, R: 0},
        ">": {U: 0, D: 1, L: 0, R: 0},
    },
    "^": {
        "A": {U: 0, D: 0, L: 0, R: 1},
        "^": {U: 0, D: 0, L: 0, R: 0},
        "v": {U: 0, D: 1, L: 0, R: 0},
        "<": {U: 0, D: 1, L: 1, R: 0},
        ">": {U: 0, D: 1, L: 0, R: 1},
    },
    "v": {
        "A": {U: 1, D: 0, L: 0, R: 1},
        "^": {U: 1, D: 0, L: 0, R: 0},
        "v": {U: 0, D: 0, L: 0, R: 0},
        "<": {U: 0, D: 0, L: 1, R: 0},
        ">": {U: 0, D: 0, L: 0, R: 1},
    },
    "<": {
        "A": {U: 1, D: 0, L: 0, R: 2},
        "^": {U: 1, D: 0, L: 0, R: 1},
        "v": {U: 0, D: 0, L: 0, R: 1},
        "<": {U: 0, D: 0, L: 0, R: 0},
        ">": {U: 0, D: 0, L: 0, R: 2},
    },
    ">": {
        "A": {U: 1, D: 0, L: 0, R: 0},
        "^": {U: 1, D: 0, L: 1, R: 0},
        "v": {U: 0, D: 0, L: 1, R: 0},
        "<": {U: 0, D: 0, L: 2, R: 0},
        ">": {U: 0, D: 0, L: 0, R: 0},
    },
}


@cache
def numpad_paths(src: str, tgt: str) -> frozenset[str]:
    p = NUMPAD_PRESSES[src][tgt]
    u, d, l, r = p[U], p[D], p[L], p[R]
    out = set()
    # vertical first
    if u:
        out.add(u * U + l * L + r * R + A)
    elif d and not (src in "147" and tgt in "0A"):
        out.add(d * D + l * L + r * R + A)
    elif not d:
        out.add(l * L + r * R + A)

    # Horizontal first
    if r:
        out.add(r * R + u * U + d * D + A)
    elif l and not (src in "0A" and tgt in "147"):
        out.add(l * L + u * U + d * D + A)
    elif not l:
        out.add(u * U + d * D + A)
    return frozenset(out)


@cache
def arrow_paths(src: str, tgt: str) -> frozenset[str]:
    p = ARROW_PRESSES[src][tgt]
    out = set()
    u, d, l, r = p[U], p[D], p[L], p[R]
    # vertical first
    if d:
        out.add(d * D + l * L + r * R + A)
    elif u and not (src == "<" and tgt in "^A"):
        out.add(u * U + l * L + r * R + A)
    elif not u:
        out.add(l * L + r * R + A)

    # Horizontal first
    if r:
        out.add(r * R + u * U + d * D + A)
    elif l and not (src in "^A" and tgt == "<"):
        out.add(l * L + u * U + d * D + A)
    elif not l:
        out.add(u * U + d * D + A)
    return frozenset(out)
